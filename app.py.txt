import streamlit as st
import math

# ================= ææ–™ä¸éœ€æ±‚ç±» =================
class Material:
    def __init__(self, thickness, width, length, density=2.71):
        self.thickness = thickness
        self.width = width
        self.length = length
        self.density = density
        self.weight_per_sheet = thickness * width * length * density / 1000000

class Requirement:
    def __init__(self, thickness, width, need_weight):
        self.thickness = thickness
        self.width = width
        self.need_weight = need_weight

# ================= é…åˆ€é€»è¾‘ =================
def optimize_cut(mother, requirements):
    solutions = []
    for req in requirements:
        if abs(req.thickness - mother.thickness) > 1e-6:
            solutions.append({
                "åšåº¦(mm)": req.thickness,
                "éœ€æ±‚å®½åº¦(mm)": req.width,
                "éœ€æ±‚é‡é‡(kg)": req.need_weight,
                "ç»“æœ": f"åšåº¦ä¸åŒ¹é…ï¼ˆæ¯æ–™{mother.thickness} vs éœ€æ±‚{req.thickness}ï¼‰"
            })
            continue

        weight_per_strip = (req.width / mother.width) * mother.weight_per_sheet
        strips_needed = math.ceil(req.need_weight / weight_per_strip)
        strips_per_sheet = mother.width // req.width
        leftover = mother.width - strips_per_sheet * req.width

        if 3 <= leftover <= 5:
            assigned_weight = strips_needed * weight_per_strip
            solutions.append({
                "åšåº¦(mm)": req.thickness,
                "éœ€æ±‚å®½åº¦(mm)": req.width,
                "éœ€æ±‚é‡é‡(kg)": req.need_weight,
                "å•æ¡é‡é‡(kg)": round(weight_per_strip, 3),
                "æ‰€éœ€æ¡æ•°": strips_needed,
                "æ»¡è¶³é‡é‡(kg)": round(assigned_weight, 3),
                "å•æ¿å¯è£æ¡æ•°": int(strips_per_sheet),
                "æ¯æ–™ä½™è¾¹(mm)": int(leftover),
                "ç»“æœ": "âœ… å¯åˆ‡å‰²"
            })
        else:
            solutions.append({
                "åšåº¦(mm)": req.thickness,
                "éœ€æ±‚å®½åº¦(mm)": req.width,
                "éœ€æ±‚é‡é‡(kg)": req.need_weight,
                "ç»“æœ": f"âŒ ä½™è¾¹{leftover}mmï¼Œä¸åœ¨å…è®¸èŒƒå›´3-5mm"
            })
    return solutions

# ================= é¡µé¢ =================
st.set_page_config(page_title="é“æ¿é“å·é…åˆ€è®¡ç®—", page_icon="âš™", layout="wide")
st.title("âš™ é“æ¿/é“å· é…åˆ€è®¡ç®—å™¨")

st.sidebar.header("æ¯æ–™å‚æ•°")
m_thickness = st.sidebar.number_input("æ¯æ–™åšåº¦ (mm)", value=1.0)
m_width = st.sidebar.number_input("æ¯æ–™å®½åº¦ (mm)", value=1220)
m_length = st.sidebar.number_input("æ¯æ–™é•¿åº¦ (mm)", value=2440)
m_density = st.sidebar.number_input("é“ææ¯”é‡", value=2.71)

mother = Material(m_thickness, m_width, m_length, m_density)
st.write(f"ğŸ“ å•å¼ æ¯æ–™é‡é‡çº¦ **{mother.weight_per_sheet:.2f} kg**")

st.header("ğŸ“ éœ€æ±‚æ¸…å•")
reqs = []
num_items = st.number_input("éœ€æ±‚æ•°é‡", min_value=1, value=2, step=1)
for i in range(num_items):
    with st.expander(f"éœ€æ±‚ {i+1}"):
        r_thk = st.number_input(f"åšåº¦ (éœ€æ±‚{i+1}) mm", value=1.0, key=f"thk{i}")
        r_width = st.number_input(f"å®½åº¦ (éœ€æ±‚{i+1}) mm", value=305, key=f"wid{i}")
        r_weight = st.number_input(f"éœ€æ±‚é‡é‡ (kg) éœ€æ±‚{i+1}", value=500.0, key=f"wt{i}")
        reqs.append(Requirement(r_thk, r_width, r_weight))

if st.button("å¼€å§‹è®¡ç®—"):
    result = optimize_cut(mother, reqs)
    st.dataframe(result, use_container_width=True)